---
interface Props {
  content?: string;
}

const { content } = Astro.props;

// Simple markdown-to-HTML conversion for changelog with DaisyUI classes
function parseChangelog(md: string): string {
  if (!md) return "";

  return md
    .replace(/^### (.+)$/gm, '<h4 class="text-sm font-semibold opacity-60 mt-4 mb-2">$1</h4>')
    .replace(/^## \[(.+?)\] - (.+)$/gm, '<h3 class="text-base font-semibold mt-6 mb-2 first:mt-0"><span class="text-primary">$1</span> <span class="opacity-60 font-normal">- $2</span></h3>')
    .replace(/^## (.+)$/gm, '<h3 class="text-base font-semibold mt-6 mb-2 first:mt-0">$1</h3>')
    .replace(/^- (.+)$/gm, '<li class="opacity-80 ml-4 list-disc">$1</li>')
    .replace(/`([^`]+)`/g, '<kbd class="kbd kbd-xs">$1</kbd>')
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="link link-primary" target="_blank" rel="noopener">$1</a>')
    .replace(/(<li[^>]*>.*?<\/li>\n?)+/g, '<ul class="space-y-1 mb-3">$&</ul>')
    .replace(/^(?!<)(?!\s*$)(.+)$/gm, '<p class="opacity-80 mb-2">$1</p>');
}

function splitVersions(md: string): { latest: string; older: string[]; olderCount: number } {
  if (!md) return { latest: "", older: [], olderCount: 0 };

  const versionRegex = /^## \[[\d.]+(?:-\d+)?\]/gm;
  const matches = [...md.matchAll(versionRegex)];

  if (matches.length <= 1) {
    return { latest: md, older: [], olderCount: 0 };
  }

  const firstPos = matches[0].index!;
  const secondPos = matches[1].index!;
  const latest = md.slice(firstPos, secondPos).trim();
  const olderContent = md.slice(secondPos).trim();
  const older = olderContent ? [olderContent] : [];

  return { latest, older, olderCount: matches.length - 1 };
}

const versions = content ? splitVersions(content) : { latest: "", older: [], olderCount: 0 };
const latestHtml = parseChangelog(versions.latest);
const olderHtml = versions.older.length > 0 ? parseChangelog(versions.older[0]) : "";
---

{content && (
  <div class="card bg-base-100">
    <div class="card-body p-0">
      <div class="px-4 py-3 border-b border-base-300 bg-base-200">
        <h2 class="card-title text-base">
          <svg class="w-4 h-4 text-primary" viewBox="0 0 24 24" fill="currentColor">
            <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
          </svg>
          Changelog
        </h2>
      </div>
      <div class="p-4">
        <div class="changelog-content text-sm" set:html={latestHtml} />

        {versions.olderCount > 0 && (
          <div class="collapse collapse-arrow border-t border-base-300 mt-4 pt-4">
            <input type="checkbox" />
            <div class="collapse-title font-medium p-0 min-h-0">
              Show {versions.olderCount} older version{versions.olderCount > 1 ? 's' : ''}
            </div>
            <div class="collapse-content p-0">
              <div class="changelog-content text-sm pt-4" set:html={olderHtml} />
            </div>
          </div>
        )}
      </div>
    </div>
  </div>
)}

<style>
  .changelog-content :global(h3:first-child) {
    margin-top: 0;
  }
  .changelog-content :global(ul) {
    padding-left: 0;
  }
  .changelog-content :global(li) {
    margin-left: 1.25rem;
  }
</style>
