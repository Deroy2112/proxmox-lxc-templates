---
interface Props {
  code: string;
  prefix?: string;
  showCopy?: boolean;
  class?: string;
}

const {
  code,
  prefix = "$",
  showCopy = true,
  class: className = "",
} = Astro.props;

const id = `code-${Math.random().toString(36).slice(2, 9)}`;
---

<div class={`relative group ${className}`}>
  <div class="mockup-code">
    <pre data-prefix={prefix}><code id={id}>{code}</code></pre>
  </div>
  {showCopy && (
    <button
      type="button"
      class="copy-btn btn btn-ghost btn-xs absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity"
      data-copy-target={`#${id}`}
      aria-label="Copy to clipboard"
    >
      <svg
        class="copy-icon w-4 h-4"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
      <svg
        class="check-icon w-4 h-4 text-success"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </button>
  )}
</div>

<style>
  .copy-btn .check-icon {
    display: none;
  }
  .copy-btn.copied .copy-icon {
    display: none;
  }
  .copy-btn.copied .check-icon {
    display: block;
  }
</style>

<script>
  function initCopyButtons() {
    document.querySelectorAll(".copy-btn").forEach((btn) => {
      if ((btn as HTMLElement).dataset.initialized) return;
      (btn as HTMLElement).dataset.initialized = "true";

      btn.addEventListener("click", async () => {
        const targetSelector = btn.getAttribute("data-copy-target");
        if (!targetSelector) return;

        const target = document.querySelector(targetSelector);
        if (!target) return;

        const text = target.textContent || "";

        try {
          await navigator.clipboard.writeText(text);
          btn.classList.add("copied");
          setTimeout(() => btn.classList.remove("copied"), 2000);
        } catch (err) {
          console.error("Failed to copy:", err);
        }
      });
    });
  }

  document.addEventListener("astro:page-load", initCopyButtons);
  document.addEventListener("astro:after-swap", initCopyButtons);
</script>
