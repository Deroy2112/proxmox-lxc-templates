---
interface Props {
  class?: string;
  compact?: boolean;
}

const { class: className = "", compact = false } = Astro.props;
---

{compact ? (
  <button
    type="button"
    class="btn btn-ghost btn-square btn-sm theme-cycle"
    aria-label="Toggle theme"
  >
    <svg class="w-5 h-5 theme-icon-light" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1z"/>
    </svg>
    <svg class="w-5 h-5 theme-icon-dark hidden" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
    </svg>
  </button>
) : (
  <div class={`join ${className}`}>
    <button
      type="button"
      class="btn btn-sm join-item theme-btn"
      data-theme-value="light"
      aria-label="Light theme"
    >
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1z"/>
      </svg>
    </button>
    <button
      type="button"
      class="btn btn-sm join-item theme-btn"
      data-theme-value="system"
      aria-label="System theme"
    >
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/>
      </svg>
    </button>
    <button
      type="button"
      class="btn btn-sm join-item theme-btn"
      data-theme-value="dark"
      aria-label="Dark theme"
    >
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
      </svg>
    </button>
  </div>
)}

<script>
  function initThemeToggle() {
    const buttons = document.querySelectorAll(".theme-btn");
    const cycleButtons = document.querySelectorAll(".theme-cycle");
    const stored = localStorage.getItem("theme") || "system";

    function getResolvedTheme(theme: string): string {
      if (theme === "system") {
        return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
      }
      return theme;
    }

    function updateUI(theme: string) {
      // Update join buttons
      buttons.forEach((btn) => {
        const value = btn.getAttribute("data-theme-value");
        btn.classList.toggle("btn-active", value === theme);
      });

      // Update cycle button icons
      const resolved = getResolvedTheme(theme);
      document.querySelectorAll(".theme-icon-light").forEach(el => {
        (el as HTMLElement).style.display = resolved === "light" ? "block" : "none";
      });
      document.querySelectorAll(".theme-icon-dark").forEach(el => {
        (el as HTMLElement).style.display = resolved === "dark" ? "block" : "none";
      });
    }

    function applyTheme(theme: string) {
      const resolved = getResolvedTheme(theme);
      document.documentElement.setAttribute("data-theme", resolved);
      localStorage.setItem("theme", theme);
      updateUI(theme);
    }

    // Initialize
    updateUI(stored);

    // Listen for join button clicks
    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const value = btn.getAttribute("data-theme-value");
        if (value) applyTheme(value);
      });
    });

    // Listen for cycle button clicks (mobile)
    cycleButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const current = localStorage.getItem("theme") || "system";
        const themes = ["light", "dark", "system"];
        const nextIndex = (themes.indexOf(current) + 1) % themes.length;
        applyTheme(themes[nextIndex]);
      });
    });

    // Listen for system preference changes
    window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
      if (localStorage.getItem("theme") === "system") {
        applyTheme("system");
      }
    });
  }

  initThemeToggle();
  document.addEventListener("astro:after-swap", initThemeToggle);
</script>
