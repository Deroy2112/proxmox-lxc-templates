---
interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;
const basePath = import.meta.env.BASE_URL;
---

<!-- Mobile Header - only visible on mobile -->
<header class={`mobile-header ${className}`}>
  <!-- Menu Button (left) -->
  <button
    type="button"
    id="mobile-menu-btn"
    class="menu-btn"
    aria-label="Open menu"
    aria-expanded="false"
  >
    <svg class="hamburger-icon w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
    <svg class="close-icon w-5 h-5 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>

  <!-- Logo (center) -->
  <a href={basePath} class="logo-link">
    <img src={`${basePath}favicon.svg`} alt="" class="w-6 h-6" />
    <span class="font-semibold text-[var(--text-primary)]">Proxmox LXC</span>
  </a>

  <!-- Theme Toggle (right) -->
  <div class="theme-toggle-compact">
    <button
      type="button"
      class="theme-btn-compact"
      id="mobile-theme-btn"
      aria-label="Toggle theme"
    >
      <svg class="sun-icon w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
      </svg>
      <svg class="moon-icon w-5 h-5 hidden" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
      </svg>
    </button>
  </div>
</header>

<!-- Overlay for mobile menu -->
<div id="mobile-overlay" class="mobile-overlay"></div>

<style>
  .mobile-header {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 3.5rem;
    padding: 0 1rem;
    align-items: center;
    justify-content: space-between;
    background: var(--glass-bg);
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    border-bottom: 1px solid var(--border-color);
    z-index: 50;
  }

  .menu-btn {
    padding: 0.5rem;
    border-radius: 0.5rem;
    color: var(--text-primary);
    transition: background-color 150ms ease;
  }

  .menu-btn:hover {
    background: var(--bg-tertiary);
  }

  .logo-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .theme-btn-compact {
    padding: 0.5rem;
    border-radius: 0.5rem;
    color: var(--text-muted);
    transition: all 150ms ease;
  }

  .theme-btn-compact:hover {
    color: var(--text-primary);
    background: var(--bg-tertiary);
  }

  .mobile-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    z-index: 35;
    opacity: 0;
    transition: opacity 300ms ease;
  }

  .mobile-overlay.visible {
    opacity: 1;
  }

  @media (max-width: 768px) {
    .mobile-header {
      display: flex;
    }

    .mobile-overlay.open {
      display: block;
    }
  }
</style>

<script>
  function initMobileHeader() {
    const btn = document.getElementById("mobile-menu-btn");
    const overlay = document.getElementById("mobile-overlay");
    const sidebar = document.querySelector(".sidebar");
    const hamburger = btn?.querySelector(".hamburger-icon");
    const closeIcon = btn?.querySelector(".close-icon");
    const themeBtn = document.getElementById("mobile-theme-btn");
    const sunIcon = themeBtn?.querySelector(".sun-icon");
    const moonIcon = themeBtn?.querySelector(".moon-icon");

    if (!btn || !overlay || !sidebar) return;

    let isOpen = false;

    // Update theme icon based on current theme
    function updateThemeIcon() {
      const currentTheme = document.documentElement.getAttribute("data-theme");
      const isDark = currentTheme === "dark";
      sunIcon?.classList.toggle("hidden", isDark);
      moonIcon?.classList.toggle("hidden", !isDark);
    }

    function toggle(open?: boolean) {
      isOpen = open ?? !isOpen;

      sidebar.classList.toggle("open", isOpen);
      overlay.classList.toggle("open", isOpen);
      btn.setAttribute("aria-expanded", String(isOpen));
      document.body.classList.toggle("overflow-hidden", isOpen);

      // Toggle icons
      hamburger?.classList.toggle("hidden", isOpen);
      closeIcon?.classList.toggle("hidden", !isOpen);

      // Animate overlay
      if (isOpen) {
        requestAnimationFrame(() => {
          overlay.classList.add("visible");
        });
      } else {
        overlay.classList.remove("visible");
      }
    }

    btn.addEventListener("click", () => toggle());
    overlay.addEventListener("click", () => toggle(false));

    // Theme toggle - cycle through: light -> dark -> system
    themeBtn?.addEventListener("click", () => {
      const stored = localStorage.getItem("theme") || "system";
      let newTheme: string;

      if (stored === "light") {
        newTheme = "dark";
      } else if (stored === "dark") {
        newTheme = "system";
      } else {
        newTheme = "light";
      }

      // Apply theme
      let resolvedTheme = newTheme;
      if (newTheme === "system") {
        resolvedTheme = window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "light";
      }
      document.documentElement.setAttribute("data-theme", resolvedTheme);
      localStorage.setItem("theme", newTheme);

      // Update sidebar theme buttons if visible
      document.querySelectorAll(".theme-btn").forEach((b) => {
        const value = b.getAttribute("data-theme-value");
        b.classList.toggle("active", value === newTheme);
      });

      updateThemeIcon();
    });

    // Close on escape
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && isOpen) {
        toggle(false);
      }
    });

    // Close on navigation
    sidebar.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", () => {
        if (window.innerWidth <= 768) {
          toggle(false);
        }
      });
    });

    // Initialize theme icon
    updateThemeIcon();

    // Watch for theme changes
    const observer = new MutationObserver(updateThemeIcon);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["data-theme"],
    });
  }

  initMobileHeader();
  document.addEventListener("astro:after-swap", initMobileHeader);
</script>
