---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import AppShell from "@/components/layout/AppShell.astro";
import TemplateHero from "@/components/template/TemplateHero.astro";
import InstallCommand from "@/components/template/InstallCommand.astro";
import ResourcesPanel from "@/components/template/ResourcesPanel.astro";
import PortsTable from "@/components/template/PortsTable.astro";
import PathsTable from "@/components/template/PathsTable.astro";
import CredentialsPanel from "@/components/template/CredentialsPanel.astro";
import FAQAccordion from "@/components/template/FAQAccordion.astro";
import ChangelogSection from "@/components/template/ChangelogSection.astro";
import Button from "@/components/ui/Button.astro";

// Category definitions (inline)
const categoryDefs = [
  { name: "media", label: "Media" },
  { name: "network", label: "Network" },
  { name: "database", label: "Database" },
  { name: "automation", label: "Automation" },
  { name: "monitoring", label: "Monitoring" },
  { name: "storage", label: "Storage" },
  { name: "security", label: "Security" },
  { name: "development", label: "Development" },
];

export async function getStaticPaths() {
  const templates = await getCollection("templates");
  return templates.map((template) => ({
    params: { slug: template.data.name },
    props: { template, allTemplates: templates },
  }));
}

const { template, allTemplates } = Astro.props;
const data = template.data;

// Build categories with counts
const categories = categoryDefs.map((c) => ({
  ...c,
  count: allTemplates.filter((t: typeof template) => t.data.category === c.name).length,
}));

const totalCount = allTemplates.length;
const basePath = import.meta.env.BASE_URL;
---

<BaseLayout
  title={data.name.charAt(0).toUpperCase() + data.name.slice(1)}
  description={data.description}
>
  <AppShell categories={categories} totalCount={totalCount}>
    <!-- Back Button -->
    <div class="mb-6">
      <Button href={basePath} variant="ghost" size="sm">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back to Templates
      </Button>
    </div>

    <!-- Hero -->
    <TemplateHero
      name={data.name}
      description={data.description}
      category={data.category}
      icon={data.icon}
      version={data.version}
      build_version={data.build_version}
      base_os={data.base_os}
      architecture={data.architecture}
    />

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Column (2/3) -->
      <div class="lg:col-span-2 space-y-6 min-w-0">
        <!-- Installation -->
        <InstallCommand
          name={data.name}
          download_url={data.download_url}
          sha512={data.sha512}
          quick_start={data.quick_start}
        />

        <!-- FAQ -->
        {data.faq && data.faq.length > 0 && (
          <FAQAccordion items={data.faq} />
        )}

        <!-- Changelog -->
        {data.changelog && (
          <ChangelogSection content={data.changelog} />
        )}
      </div>

      <!-- Sidebar Column (1/3) -->
      <div class="lg:col-span-1 space-y-6 lg:sticky lg:top-6 lg:self-start">
        <!-- Download Button -->
        {data.download_url && (
          <a
            href={data.download_url}
            class="btn btn-primary w-full gap-2"
            download
          >
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
            Download Template
          </a>
        )}

        <!-- Resources -->
        <ResourcesPanel
          memory_min={data.resources.memory_min}
          memory_recommended={data.resources.memory_recommended}
          disk_min={data.resources.disk_min}
          disk_recommended={data.resources.disk_recommended}
          cores={data.resources.cores}
        />

        <!-- Ports -->
        {data.ports && <PortsTable ports={data.ports} />}

        <!-- Paths -->
        {data.paths && <PathsTable paths={data.paths} />}

        <!-- Credentials -->
        {data.credentials && (
          <CredentialsPanel
            username={data.credentials.username}
            password={data.credentials.password}
            note={data.credentials.note}
          />
        )}

        <!-- Release Info -->
        {data.release_url && (
          <div class="text-sm opacity-60 space-y-1">
            {data.release_date && (
              <p>
                Released: {new Date(data.release_date).toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })}
              </p>
            )}
            <p>
              <a
                href={data.release_url}
                class="link link-primary"
                target="_blank"
                rel="noopener noreferrer"
              >
                View on GitHub â†’
              </a>
            </p>
          </div>
        )}
      </div>
    </div>
  </AppShell>
</BaseLayout>
