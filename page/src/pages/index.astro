---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import Sidebar from "@/components/Sidebar.astro";
import Header from "@/components/Header.astro";
import Toast from "@/components/Toast.astro";
import TemplateCard from "@/components/TemplateCard.astro";
import TemplateDetail from "@/components/TemplateDetail.astro";

// Category definitions
const categoryDefs = [
  { name: "media", label: "Media" },
  { name: "network", label: "Network" },
  { name: "database", label: "Database" },
  { name: "automation", label: "Automation" },
  { name: "monitoring", label: "Monitoring" },
  { name: "storage", label: "Storage" },
  { name: "security", label: "Security" },
  { name: "development", label: "Development" },
];

// Load templates from content collection
let templates: Awaited<ReturnType<typeof getCollection<"templates">>> = [];
try {
  templates = await getCollection("templates");
} catch {
  // No templates yet - that's fine
}

// Build categories with counts
const categories = categoryDefs.map((c) => ({
  ...c,
  count: templates.filter((t) => t.data.category === c.name).length,
}));

// Sort templates by name
const sortedTemplates = templates.sort((a, b) =>
  a.data.name.localeCompare(b.data.name)
);

const totalCount = templates.length;

---

<BaseLayout title="LXC Templates" description="Custom LXC container templates for Proxmox VE. Pre-configured, optimized, and ready to deploy.">
  <div class="app-layout">
    <!-- Sidebar -->
    <Sidebar categories={categories} activeCategory="all" totalCount={totalCount} />

    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Main -->
    <main class="main">
      <!-- Mobile Header -->
      <Header />

      <!-- Header -->
      <header class="header">
        <div class="header-inner">
          <h1 class="header-title">LXC Templates</h1>
          <div class="header-actions">
            <a href="https://github.com/deroy2112/proxmox-lxc-templates" target="_blank" rel="noopener noreferrer" class="btn btn-icon" title="GitHub Repository">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor">
                <path d="M208.31,75.68A59.78,59.78,0,0,0,202.93,28,8,8,0,0,0,196,24a59.75,59.75,0,0,0-48,24H124A59.75,59.75,0,0,0,76,24a8,8,0,0,0-6.93,4,59.78,59.78,0,0,0-5.38,47.68A58.14,58.14,0,0,0,56,104v8a56.06,56.06,0,0,0,48.44,55.47A39.8,39.8,0,0,0,96,192v8H72a24,24,0,0,1-24-24A40,40,0,0,0,8,136a8,8,0,0,0,0,16,24,24,0,0,1,24,24,40,40,0,0,0,40,40H96v16a8,8,0,0,0,16,0V192a24,24,0,0,1,48,0v40a8,8,0,0,0,16,0V192a39.8,39.8,0,0,0-8.44-24.53A56.06,56.06,0,0,0,216,112v-8A58.14,58.14,0,0,0,208.31,75.68Z"/>
              </svg>
            </a>
          </div>
        </div>
      </header>

      <!-- Content -->
      <div class="content">
        <!-- Template List (default visible) -->
        <div id="template-list">
          <!-- Category Pills -->
          <section class="section">
            <div class="category-pills" id="category-pills">
              <button class="pill active" data-category="all">All</button>
              {categories.filter(c => c.count > 0).map((category) => (
                <button class="pill" data-category={category.name}>
                  {category.label}
                </button>
              ))}
            </div>
          </section>

          <!-- All Apps Section -->
          <section class="section">
            <div class="section-header">
              <h2 class="section-title">All Templates</h2>
              <span class="text-sm text-muted"><span id="visible-count">{totalCount}</span> templates</span>
            </div>

            <!-- App Grid -->
            <div id="template-grid" class="app-grid">
              {sortedTemplates.length > 0 ? (
                sortedTemplates.map((template, index) => (
                  <TemplateCard
                    name={template.data.name}
                    description={template.data.description}
                    category={template.data.category}
                    icon={template.data.icon}
                    version={template.data.version}
                    build_version={template.data.build_version}
                    base_os={template.data.base_os}
                    memory_min={template.data.resources.memory_min}
                    disk_min={template.data.resources.disk_min}
                    cores={template.data.resources.cores}
                    templateData={JSON.stringify(template.data)}
                    index={index}
                  />
                ))
              ) : (
                <div class="empty-state">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor">
                    <path d="M216,72H56a8,8,0,0,1,0-16H192a8,8,0,0,0,0-16H56A24,24,0,0,0,32,64V192a24,24,0,0,0,24,24H216a16,16,0,0,0,16-16V88A16,16,0,0,0,216,72Zm0,128H56a8,8,0,0,1-8-8V86.63A23.84,23.84,0,0,0,56,88H216Z" />
                  </svg>
                  <p>No templates available yet.</p>
                  <span class="text-muted">Templates will appear here after the first release.</span>
                </div>
              )}
            </div>

            <!-- No Results Message (hidden by default) -->
            <div id="no-results" class="empty-state hidden">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor">
                <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z" />
              </svg>
              <p>No templates found.</p>
              <span class="text-muted">Try a different search term or category.</span>
            </div>
          </section>
        </div>

        <!-- Template Detail (hidden by default) -->
        <TemplateDetail />
      </div>
    </main>
  </div>

  <!-- Toast -->
  <Toast />
</BaseLayout>

<style>
  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 64px 24px;
  }

  .empty-state svg {
    width: 64px;
    height: 64px;
    opacity: 0.3;
    margin-bottom: 16px;
  }

  .empty-state p {
    font-size: 1rem;
    margin-bottom: 8px;
  }
</style>

<script>
  // Template data map for quick access
  const templatesMap = new Map<string, Record<string, unknown>>();

  function initApp() {
    const searchInput = document.getElementById("search-input") as HTMLInputElement | null;
    const grid = document.getElementById("template-grid");
    const noResults = document.getElementById("no-results");
    const cards = grid?.querySelectorAll(".app-card");
    const pillButtons = document.querySelectorAll("#category-pills .pill");
    const sidebarButtons = document.querySelectorAll(".sidebar-nav button[data-category]");
    const visibleCountEl = document.getElementById("visible-count");

    if (!grid || !cards) return;

    let currentCategory = "all";
    let currentQuery = "";

    // Build templates map
    templatesMap.clear();
    cards.forEach((card) => {
      const dataStr = card.getAttribute("data-template");
      if (dataStr) {
        try {
          const data = JSON.parse(dataStr);
          templatesMap.set(data.name, data);
        } catch {
          // Invalid JSON, skip
        }
      }
    });

    // Get query from URL
    const urlParams = new URLSearchParams(window.location.search);
    const initialQuery = urlParams.get("q") || "";
    const initialCategory = urlParams.get("category") || "all";

    if (initialQuery && searchInput) {
      searchInput.value = initialQuery;
      currentQuery = initialQuery.toLowerCase();
    }
    currentCategory = initialCategory;

    function updateCategoryUI() {
      // Update pills
      pillButtons.forEach((btn) => {
        const cat = btn.getAttribute("data-category");
        btn.classList.toggle("active", cat === currentCategory);
      });

      // Update sidebar
      sidebarButtons.forEach((btn) => {
        const cat = btn.getAttribute("data-category");
        btn.classList.toggle("active", cat === currentCategory);
      });
    }

    function applyFilters() {
      let visibleCount = 0;

      cards.forEach((card) => {
        const name = card.getAttribute("data-name") || "";
        const description = card.getAttribute("data-description") || "";
        const category = card.getAttribute("data-category") || "";

        const matchesSearch =
          !currentQuery ||
          name.includes(currentQuery) ||
          description.includes(currentQuery);

        const matchesCategory =
          currentCategory === "all" || category === currentCategory;

        const isVisible = matchesSearch && matchesCategory;
        (card as HTMLElement).style.display = isVisible ? "" : "none";

        if (isVisible) {
          visibleCount++;
        }
      });

      // Update visible count
      if (visibleCountEl) {
        visibleCountEl.textContent = String(visibleCount);
      }

      // Show/hide no results
      noResults?.classList.toggle("hidden", visibleCount > 0);
      grid?.classList.toggle("hidden", visibleCount === 0 && cards.length > 0);
    }

    // Search input handler (debounced)
    let timeout: ReturnType<typeof setTimeout>;
    searchInput?.addEventListener("input", () => {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        currentQuery = searchInput.value.toLowerCase();

        // Close detail view if open
        if (!document.getElementById("template-detail")?.classList.contains("hidden")) {
          hideTemplateDetail();
        }

        applyFilters();

        // Update URL
        const url = new URL(window.location.href);
        if (currentQuery) {
          url.searchParams.set("q", searchInput.value);
        } else {
          url.searchParams.delete("q");
        }
        history.replaceState(null, "", url.toString());
      }, 150);
    });

    // Category pill click handler
    function handleCategoryClick(category: string) {
      currentCategory = category;

      // Close detail view if open
      if (!document.getElementById("template-detail")?.classList.contains("hidden")) {
        hideTemplateDetail();
      }

      updateCategoryUI();
      applyFilters();

      // Update URL
      const url = new URL(window.location.href);
      if (currentCategory !== "all") {
        url.searchParams.set("category", currentCategory);
      } else {
        url.searchParams.delete("category");
      }
      history.replaceState(null, "", url.toString());
    }

    pillButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        handleCategoryClick(btn.getAttribute("data-category") || "all");
      });
    });

    sidebarButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        handleCategoryClick(btn.getAttribute("data-category") || "all");

        // Close mobile sidebar
        document.querySelector(".sidebar")?.classList.remove("open");
        document.getElementById("sidebar-overlay")?.classList.remove("open");
      });
    });

    // Initial filter
    updateCategoryUI();
    applyFilters();
  }

  // Show template detail
  function showTemplateDetail(data: Record<string, unknown>) {
    populateDetail(data);

    document.getElementById("template-list")?.classList.add("hidden");
    document.getElementById("template-detail")?.classList.remove("hidden");

    // Update URL (Deep-Link)
    const url = new URL(location.href);
    url.searchParams.set("template", data.name as string);
    url.searchParams.delete("q");
    url.searchParams.delete("category");
    history.pushState({ template: data.name }, "", url);

    // Scroll to top
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // Hide template detail
  function hideTemplateDetail() {
    document.getElementById("template-detail")?.classList.add("hidden");
    document.getElementById("template-list")?.classList.remove("hidden");

    const url = new URL(location.href);
    url.searchParams.delete("template");
    history.pushState({}, "", url);
  }

  // Escape HTML for safe insertion
  function escapeHtml(text: string): string {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  // Populate detail with template data
  function populateDetail(data: Record<string, unknown>) {
    const iconUrl = `https://cdn.jsdelivr.net/gh/homarr-labs/dashboard-icons@main/svg/${data.icon}.svg`;
    const displayName = (data.name as string).charAt(0).toUpperCase() + (data.name as string).slice(1);

    // Icon & Name
    const iconEl = document.getElementById("detail-icon") as HTMLImageElement | null;
    if (iconEl) iconEl.src = iconUrl;
    const nameEl = document.getElementById("detail-name");
    if (nameEl) nameEl.textContent = displayName;

    // Description
    const descEl = document.getElementById("detail-description");
    if (descEl) descEl.textContent = data.description as string;

    // Badges
    const badgesEl = document.getElementById("detail-badges");
    if (badgesEl) {
      badgesEl.innerHTML = `
        <span class="badge badge-success">v${data.version}-${data.build_version}</span>
        <span class="tag">${data.base_os}</span>
        <span class="badge badge-info">${data.category}</span>
      `;
    }

    // Download
    const downloadSection = document.getElementById("detail-download-section");
    const wgetEl = document.getElementById("detail-wget") as HTMLInputElement | null;
    const sha512El = document.getElementById("detail-sha512");

    if (data.download_url) {
      downloadSection?.classList.remove("hidden");
      if (wgetEl) wgetEl.value = `wget ${data.download_url}`;
      const sha512Wrapper = document.getElementById("detail-sha512-wrapper");
      if (sha512El && sha512Wrapper) {
        if (data.sha512) {
          (sha512El as HTMLInputElement).value = `SHA512: ${data.sha512}`;
          sha512El.setAttribute("data-sha512", data.sha512 as string);
          sha512Wrapper.classList.remove("hidden");
        } else {
          (sha512El as HTMLInputElement).value = "";
          sha512Wrapper.classList.add("hidden");
        }
      }
    } else {
      downloadSection?.classList.add("hidden");
    }

    // Quick Start
    const qsSection = document.getElementById("detail-quickstart-section");
    const qsEl = document.getElementById("detail-quickstart");
    if (data.quick_start && qsSection && qsEl) {
      qsSection.classList.remove("hidden");
      qsEl.innerHTML = `<pre><code>${escapeHtml(data.quick_start as string)}</code></pre>`;
    } else {
      qsSection?.classList.add("hidden");
    }

    // Resources (Stats)
    const resourcesEl = document.getElementById("detail-resources");
    const resources = data.resources as Record<string, unknown> | undefined;
    if (resourcesEl && resources) {
      const memRec = resources.memory_recommended as number;
      const memMin = resources.memory_min as number;
      resourcesEl.innerHTML = `
        <div class="stat">
          <div class="stat-value">${memRec >= 1024 ? (memRec / 1024) + 'GB' : memRec + 'MB'}</div>
          <div class="stat-label">Memory</div>
          <div class="stat-desc">min: ${memMin >= 1024 ? (memMin / 1024) + 'GB' : memMin + 'MB'}</div>
        </div>
        <div class="stat">
          <div class="stat-value">${resources.disk_recommended}</div>
          <div class="stat-label">Disk</div>
          <div class="stat-desc">min: ${resources.disk_min}</div>
        </div>
        <div class="stat">
          <div class="stat-value">${resources.cores}</div>
          <div class="stat-label">${(resources.cores as number) === 1 ? 'Core' : 'Cores'}</div>
        </div>
      `;
    }

    // Ports
    const portsSection = document.getElementById("detail-ports-section");
    const portsEl = document.getElementById("detail-ports");
    const ports = data.ports as Array<{port: number; description: string}> | undefined;
    if (ports?.length && portsSection && portsEl) {
      portsSection.classList.remove("hidden");
      portsEl.innerHTML = ports.map(p =>
        `<tr><td class="font-mono">${p.port}</td><td>${escapeHtml(p.description)}</td></tr>`
      ).join("");
    } else {
      portsSection?.classList.add("hidden");
    }

    // Paths
    const pathsSection = document.getElementById("detail-paths-section");
    const pathsEl = document.getElementById("detail-paths");
    const paths = data.paths as Array<{path: string; description: string}> | undefined;
    if (paths?.length && pathsSection && pathsEl) {
      pathsSection.classList.remove("hidden");
      pathsEl.innerHTML = paths.map(p =>
        `<tr><td class="font-mono text-xs">${escapeHtml(p.path)}</td><td>${escapeHtml(p.description)}</td></tr>`
      ).join("");
    } else {
      pathsSection?.classList.add("hidden");
    }

    // Credentials
    const credsSection = document.getElementById("detail-credentials-section");
    const credsEl = document.getElementById("detail-credentials");
    const credentials = data.credentials as {username: string; password: string; note?: string} | undefined;
    if (credentials && credsSection && credsEl) {
      credsSection.classList.remove("hidden");
      let html = `User: <code>${escapeHtml(credentials.username)}</code> / Pass: <code>${escapeHtml(credentials.password)}</code>`;
      if (credentials.note) {
        html += `<br><span class="text-muted">${escapeHtml(credentials.note)}</span>`;
      }
      credsEl.innerHTML = html;
    } else {
      credsSection?.classList.add("hidden");
    }

    // FAQ
    const faqSection = document.getElementById("detail-faq-section");
    const faqEl = document.getElementById("detail-faq");
    const faq = data.faq as Array<{question: string; answer: string}> | undefined;
    if (faq?.length && faqSection && faqEl) {
      faqSection.classList.remove("hidden");
      faqEl.innerHTML = faq.map((item, i) => `
        <div class="accordion-item ${i === 0 ? 'open' : ''}">
          <button class="accordion-header">
            ${escapeHtml(item.question)}
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor">
              <path d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z" />
            </svg>
          </button>
          <div class="accordion-content"><p>${escapeHtml(item.answer)}</p></div>
        </div>
      `).join("");

      // Bind accordion clicks
      faqEl.querySelectorAll(".accordion-header").forEach(header => {
        header.addEventListener("click", () => {
          const item = header.parentElement;
          item?.classList.toggle("open");
        });
      });
    } else {
      faqSection?.classList.add("hidden");
    }

    // Changelog
    const changelogSection = document.getElementById("detail-changelog-section");
    const changelogEl = document.getElementById("detail-changelog");
    const changelogItem = document.getElementById("changelog-item");
    const changelogToggle = document.getElementById("changelog-toggle");
    if (data.changelog && changelogSection && changelogEl) {
      changelogSection.classList.remove("hidden");
      changelogEl.innerHTML = `<p>${escapeHtml(data.changelog as string).replace(/\n/g, '<br>')}</p>`;

      // Toggle handler - use accordion-item.open class
      changelogToggle?.addEventListener("click", () => {
        changelogItem?.classList.toggle("open");
      });
    } else {
      changelogSection?.classList.add("hidden");
    }

    // Release Info
    const releaseSection = document.getElementById("detail-release-section");
    const releaseDateEl = document.getElementById("detail-release-date");
    const githubLinkEl = document.getElementById("detail-github-link") as HTMLAnchorElement | null;

    if (data.release_url || data.release_date) {
      releaseSection?.classList.remove("hidden");
      if (data.release_date && releaseDateEl) {
        releaseDateEl.textContent = `Released: ${new Date(data.release_date as string).toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        })}`;
      }
      if (data.release_url && githubLinkEl) {
        githubLinkEl.href = data.release_url as string;
      }
    } else {
      releaseSection?.classList.add("hidden");
    }
  }

  // Initialize detail handlers
  function initDetail() {
    const grid = document.getElementById("template-grid");
    const cards = grid?.querySelectorAll(".app-card");
    const backBtn = document.getElementById("back-to-list");
    const wgetCopyBtn = document.getElementById("detail-wget-copy");
    const wgetInput = document.getElementById("detail-wget") as HTMLInputElement | null;
    const sha512CopyBtn = document.getElementById("detail-sha512-copy");

    // Copy wget command to clipboard
    wgetCopyBtn?.addEventListener("click", async () => {
      if (wgetInput?.value) {
        try {
          await navigator.clipboard.writeText(wgetInput.value);
          window.showToast?.("Copied to clipboard!");
        } catch {
          wgetInput.select();
          document.execCommand("copy");
          window.showToast?.("Copied!");
        }
      }
    });

    // Copy SHA512 to clipboard
    sha512CopyBtn?.addEventListener("click", async () => {
      const sha512El = document.getElementById("detail-sha512");
      const sha512Value = sha512El?.getAttribute("data-sha512");
      if (sha512Value) {
        try {
          await navigator.clipboard.writeText(sha512Value);
          window.showToast?.("SHA512 copied to clipboard!");
        } catch {
          window.showToast?.("Failed to copy");
        }
      }
    });

    // Card click handler
    function handleCardClick(card: Element) {
      const dataStr = card.getAttribute("data-template");
      if (dataStr) {
        try {
          const data = JSON.parse(dataStr);
          showTemplateDetail(data);
        } catch {
          // Invalid JSON
        }
      }
    }

    cards?.forEach((card) => {
      card.addEventListener("click", () => handleCardClick(card));
      card.addEventListener("keydown", (e) => {
        if ((e as KeyboardEvent).key === "Enter" || (e as KeyboardEvent).key === " ") {
          e.preventDefault();
          handleCardClick(card);
        }
      });
    });

    // Back button handler
    backBtn?.addEventListener("click", hideTemplateDetail);

    // Browser Back/Forward
    window.addEventListener("popstate", (e) => {
      if ((e.state as {template?: string} | null)?.template) {
        const data = templatesMap.get((e.state as {template: string}).template);
        if (data) {
          populateDetail(data);
          document.getElementById("template-list")?.classList.add("hidden");
          document.getElementById("template-detail")?.classList.remove("hidden");
        }
      } else {
        document.getElementById("template-detail")?.classList.add("hidden");
        document.getElementById("template-list")?.classList.remove("hidden");
      }
    });

    // Deep-Link on page load
    const params = new URLSearchParams(location.search);
    const templateName = params.get("template");
    if (templateName) {
      const data = templatesMap.get(templateName);
      if (data) {
        populateDetail(data);
        document.getElementById("template-list")?.classList.add("hidden");
        document.getElementById("template-detail")?.classList.remove("hidden");
      }
    }
  }

  // Mobile sidebar toggle
  function initMobileSidebar() {
    const menuToggle = document.getElementById("menu-toggle");
    const sidebar = document.querySelector(".sidebar");
    const overlay = document.getElementById("sidebar-overlay");

    menuToggle?.addEventListener("click", () => {
      sidebar?.classList.toggle("open");
      overlay?.classList.toggle("open");
    });

    overlay?.addEventListener("click", () => {
      sidebar?.classList.remove("open");
      overlay?.classList.remove("open");
    });
  }

  // Keyboard shortcut for search
  function initKeyboardShortcuts() {
    document.addEventListener("keydown", (e) => {
      // Cmd/Ctrl + K to focus search
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        const searchInput = document.getElementById("search-input") as HTMLInputElement | null;
        searchInput?.focus();
      }
    });
  }

  // Initialize everything
  initApp();
  initDetail();
  initMobileSidebar();
  initKeyboardShortcuts();

  document.addEventListener("astro:after-swap", () => {
    initApp();
    initDetail();
    initMobileSidebar();
    initKeyboardShortcuts();
  });
</script>
