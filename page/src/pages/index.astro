---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import Sidebar from "@/components/Sidebar.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Toast from "@/components/Toast.astro";
import TemplateCard from "@/components/TemplateCard.astro";
import TemplateDetail from "@/components/TemplateDetail.astro";

// Category definitions
const categoryDefs = [
  { name: "media", label: "Media" },
  { name: "network", label: "Network" },
  { name: "database", label: "Database" },
  { name: "automation", label: "Automation" },
  { name: "monitoring", label: "Monitoring" },
  { name: "storage", label: "Storage" },
  { name: "security", label: "Security" },
  { name: "development", label: "Development" },
];

// Load templates from content collection
let templates: Awaited<ReturnType<typeof getCollection<"templates">>> = [];
try {
  templates = await getCollection("templates");
} catch {
  // No templates yet - that's fine
}

// Build categories with counts
const categories = categoryDefs.map((c) => ({
  ...c,
  count: templates.filter((t) => t.data.category === c.name).length,
}));

// Sort templates by name
const sortedTemplates = templates.sort((a, b) =>
  a.data.name.localeCompare(b.data.name)
);

const totalCount = templates.length;

---

<BaseLayout title="LXC Templates" description="Custom LXC container templates for Proxmox VE. Pre-configured, optimized, and ready to deploy.">
  <div class="app-layout">
    <!-- Sidebar -->
    <Sidebar categories={categories} activeCategory="all" totalCount={totalCount} />

    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Main -->
    <main class="main">
      <!-- Mobile Header -->
      <Header />

      <!-- Header -->
      <header class="header">
        <div class="header-inner">
          <h1 class="header-title">LXC Templates</h1>
          <div class="header-actions">
            <a href="https://github.com/deroy2112/proxmox-lxc-templates" target="_blank" rel="noopener noreferrer" class="btn btn-icon" title="GitHub Repository">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor">
                <path d="M208.31,75.68A59.78,59.78,0,0,0,202.93,28,8,8,0,0,0,196,24a59.75,59.75,0,0,0-48,24H124A59.75,59.75,0,0,0,76,24a8,8,0,0,0-6.93,4,59.78,59.78,0,0,0-5.38,47.68A58.14,58.14,0,0,0,56,104v8a56.06,56.06,0,0,0,48.44,55.47A39.8,39.8,0,0,0,96,192v8H72a24,24,0,0,1-24-24A40,40,0,0,0,8,136a8,8,0,0,0,0,16,24,24,0,0,1,24,24,40,40,0,0,0,40,40H96v16a8,8,0,0,0,16,0V192a24,24,0,0,1,48,0v40a8,8,0,0,0,16,0V192a39.8,39.8,0,0,0-8.44-24.53A56.06,56.06,0,0,0,216,112v-8A58.14,58.14,0,0,0,208.31,75.68Z"/>
              </svg>
            </a>
          </div>
        </div>
      </header>

      <!-- Content -->
      <div class="content">
        <!-- Template List (default visible) -->
        <div id="template-list">
          <!-- Category Pills -->
          <section class="section">
            <div class="category-pills" id="category-pills">
              <button class="pill active" data-category="all">All</button>
              {categories.filter(c => c.count > 0).map((category) => (
                <button class="pill" data-category={category.name}>
                  {category.label}
                </button>
              ))}
            </div>
          </section>

          <!-- All Apps Section -->
          <section class="section">
            <div class="section-header">
              <h2 class="section-title">All Templates</h2>
              <span class="text-sm text-muted"><span id="visible-count">{totalCount}</span> templates</span>
            </div>

            <!-- App Grid -->
            <div id="template-grid" class="app-grid">
              {sortedTemplates.length > 0 ? (
                sortedTemplates.map((template, index) => (
                  <TemplateCard
                    name={template.data.name}
                    description={template.data.description}
                    category={template.data.category}
                    icon={template.data.icon}
                    version={template.data.version}
                    build_version={template.data.build_version}
                    base_os={template.data.base_os}
                    memory_min={template.data.resources.memory_min}
                    disk_min={template.data.resources.disk_min}
                    cores={template.data.resources.cores}
                    templateData={JSON.stringify(template.data)}
                    index={index}
                  />
                ))
              ) : (
                <div class="empty-state">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor">
                    <path d="M216,72H56a8,8,0,0,1,0-16H192a8,8,0,0,0,0-16H56A24,24,0,0,0,32,64V192a24,24,0,0,0,24,24H216a16,16,0,0,0,16-16V88A16,16,0,0,0,216,72Zm0,128H56a8,8,0,0,1-8-8V86.63A23.84,23.84,0,0,0,56,88H216Z" />
                  </svg>
                  <p>No templates available yet.</p>
                  <span class="text-muted">Templates will appear here after the first release.</span>
                </div>
              )}
            </div>

            <!-- No Results Message (hidden by default) -->
            <div id="no-results" class="empty-state hidden">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor">
                <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z" />
              </svg>
              <p>No templates found.</p>
              <span class="text-muted">Try a different search term or category.</span>
            </div>
          </section>
        </div>

        <!-- Template Detail (hidden by default) -->
        <TemplateDetail />
      </div>

      <!-- Footer -->
      <Footer />
    </main>
  </div>

  <!-- Toast -->
  <Toast />
</BaseLayout>

<style>
  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 64px 24px;
  }

  .empty-state svg {
    width: 64px;
    height: 64px;
    opacity: 0.3;
    margin-bottom: 16px;
  }

  .empty-state p {
    font-size: 1rem;
    margin-bottom: 8px;
  }
</style>

<script>
  import "@/scripts/template-app.ts";
</script>
