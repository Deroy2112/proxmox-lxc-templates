---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import Sidebar from "@/components/layout/Sidebar.astro";
import MobileMenu from "@/components/layout/MobileMenu.astro";
import Footer from "@/components/layout/Footer.astro";
import TemplateCard from "@/components/template/TemplateCard.astro";

// Load templates from content collection
let templates: Awaited<ReturnType<typeof getCollection<"templates">>> = [];
try {
  templates = await getCollection("templates");
} catch {
  // No templates yet - that's fine
}

// Parse categories
const categories = [
  { name: "media", label: "Media & Indexer", icon: "film", count: 0 },
  { name: "network", label: "Network & Proxy", icon: "globe", count: 0 },
  { name: "monitoring", label: "Monitoring & Tools", icon: "chart", count: 0 },
  { name: "development", label: "Development", icon: "code", count: 0 },
];

// Count templates per category
templates.forEach((t) => {
  const cat = categories.find((c) => c.name === t.data.category);
  if (cat) cat.count++;
});

// Sort templates by name
const sortedTemplates = templates.sort((a, b) =>
  a.data.name.localeCompare(b.data.name)
);

const basePath = import.meta.env.BASE_URL;
---

<BaseLayout title="Home" description="Custom LXC container templates for Proxmox VE. Pre-configured, optimized, and ready to deploy.">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <Sidebar categories={categories} activeCategory="all" />

    <!-- Mobile Menu -->
    <MobileMenu />

    <!-- Main Content -->
    <main class="flex-1 ml-0 md:ml-[var(--sidebar-width)] flex flex-col min-h-screen">
      <div class="flex-1 p-6 pt-16 md:pt-6">
        <div class="max-w-[var(--content-max)] mx-auto">
          <!-- Header -->
          <div class="mb-8">
            <h1 class="text-2xl font-bold text-[var(--text-primary)] mb-2">
              LXC Templates
            </h1>
            <p class="text-[var(--text-secondary)]">
              Pre-configured container templates for Proxmox VE 9.x
            </p>
          </div>

          <!-- Template Grid -->
          <div
            id="template-grid"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"
          >
            {sortedTemplates.length > 0 ? (
              sortedTemplates.map((template, index) => (
                <TemplateCard
                  name={template.data.name}
                  description={template.data.description}
                  category={template.data.category}
                  icon={template.data.icon}
                  version={template.data.version}
                  base_os={template.data.base_os}
                  memory_min={template.data.resources.memory_min}
                  href={`${basePath}templates/${template.data.name}/`}
                  index={index}
                />
              ))
            ) : (
              <div class="col-span-full text-center py-12 text-[var(--text-muted)]">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-50" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-1 12H5c-.55 0-1-.45-1-1V9c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v8c0 .55-.45 1-1 1z"/>
                </svg>
                <p>No templates available yet.</p>
                <p class="text-sm mt-2">Templates will appear here after the first release.</p>
              </div>
            )}
          </div>

          <!-- No Results Message (hidden by default) -->
          <div id="no-results" class="hidden text-center py-12 text-[var(--text-muted)]">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            <p>No templates found matching your search.</p>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <Footer />
    </main>
  </div>
</BaseLayout>

<script>
  function initSearch() {
    const searchInput = document.getElementById("search-input") as HTMLInputElement | null;
    const grid = document.getElementById("template-grid");
    const noResults = document.getElementById("no-results");
    const cards = grid?.querySelectorAll(".template-card");
    const categoryLinks = document.querySelectorAll("[data-category]");
    const counters = document.querySelectorAll("[data-count]");

    if (!searchInput || !grid || !cards) return;

    let currentCategory = "all";
    let currentQuery = "";

    // Get query from URL
    const urlParams = new URLSearchParams(window.location.search);
    const initialQuery = urlParams.get("q") || "";
    const initialCategory = urlParams.get("category") || "all";

    if (initialQuery) {
      searchInput.value = initialQuery;
      currentQuery = initialQuery.toLowerCase();
    }
    currentCategory = initialCategory;

    function updateCategoryUI() {
      categoryLinks.forEach((link) => {
        const cat = link.getAttribute("data-category");
        link.classList.toggle("active", cat === currentCategory);
      });
    }

    function applyFilters() {
      let visibleCount = 0;
      const categoryCounts: Record<string, number> = { all: 0 };

      cards.forEach((card) => {
        const name = card.getAttribute("data-name") || "";
        const description = card.getAttribute("data-description") || "";
        const category = card.getAttribute("data-category") || "";

        const matchesSearch =
          !currentQuery ||
          name.includes(currentQuery) ||
          description.includes(currentQuery);

        const matchesCategory =
          currentCategory === "all" || category === currentCategory;

        const isVisible = matchesSearch && matchesCategory;
        (card as HTMLElement).style.display = isVisible ? "" : "none";

        if (isVisible) {
          visibleCount++;
        }

        // Count for category (only if matches search)
        if (matchesSearch) {
          categoryCounts.all = (categoryCounts.all || 0) + 1;
          categoryCounts[category] = (categoryCounts[category] || 0) + 1;
        }
      });

      // Update counters
      counters.forEach((counter) => {
        const cat = counter.getAttribute("data-count") || "";
        counter.textContent = String(categoryCounts[cat] || 0);
      });

      // Show/hide no results
      noResults?.classList.toggle("hidden", visibleCount > 0);
      grid?.classList.toggle("hidden", visibleCount === 0);
    }

    // Search input handler (debounced)
    let timeout: ReturnType<typeof setTimeout>;
    searchInput.addEventListener("input", () => {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        currentQuery = searchInput.value.toLowerCase();
        applyFilters();

        // Update URL
        const url = new URL(window.location.href);
        if (currentQuery) {
          url.searchParams.set("q", searchInput.value);
        } else {
          url.searchParams.delete("q");
        }
        history.replaceState(null, "", url.toString());
      }, 150);
    });

    // Category click handler
    categoryLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        currentCategory = link.getAttribute("data-category") || "all";
        updateCategoryUI();
        applyFilters();

        // Update URL
        const url = new URL(window.location.href);
        if (currentCategory !== "all") {
          url.searchParams.set("category", currentCategory);
        } else {
          url.searchParams.delete("category");
        }
        history.replaceState(null, "", url.toString());
      });
    });

    // Initial filter
    updateCategoryUI();
    applyFilters();
  }

  initSearch();
  document.addEventListener("astro:after-swap", initSearch);
</script>
