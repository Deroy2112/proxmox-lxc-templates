name: Build and Deploy GitHub Pages

on:
  # Trigger after build-debian-13 completes
  workflow_run:
    workflows: ["Build Debian 13 LXC Template"]
    types:
      - completed
    branches:
      - main
  # Direct page changes
  push:
    paths:
      - 'page/**'
      - 'templates/**/config.yml'
      - 'templates/**/CHANGELOG.md'
    branches:
      - main
  # Manual trigger
  workflow_dispatch:

jobs:
  build-pages:
    runs-on: ubuntu-latest
    # Only run if build succeeded or manual/push trigger
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22 LTS
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install yq
        uses: mikefarah/yq@v4

      - name: Generate template content collection
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          CONTENT_DIR="page/src/content/templates"
          mkdir -p "$CONTENT_DIR"

          echo "Generating template content collection..."

          for template_dir in templates/*/debian-13/; do
            [[ -d "$template_dir" ]] || continue
            template=$(echo "$template_dir" | cut -d'/' -f2)
            config="${template_dir}config.yml"
            changelog="${template_dir}CHANGELOG.md"

            [[ -f "$config" ]] || continue

            echo "Processing: $template"

            # Read base config values
            NAME=$(yq -r '.name' "$config")
            VERSION=$(yq -r '.version' "$config")
            BUILD_VERSION=$(yq -r '.build_version' "$config")
            BASE_OS=$(yq -r '.base_os' "$config")
            ARCH=$(yq -r '.architecture // "amd64"' "$config")

            FULL_VERSION="${VERSION}-${BUILD_VERSION}"
            TAG="v${FULL_VERSION}-${NAME}"
            FILENAME="deroy2112-${BASE_OS}-${NAME}_${FULL_VERSION}_${ARCH}.tar.zst"

            # Get release info from GitHub
            SHA512=""
            RELEASE_DATE=""
            DOWNLOAD_URL=""
            RELEASE_URL=""

            if gh release view "$TAG" &>/dev/null; then
              SHA512=$(gh release download "$TAG" --pattern "${FILENAME}.sha512" -O - 2>/dev/null | cut -d' ' -f1 || echo "")
              RELEASE_DATE=$(gh release view "$TAG" --json publishedAt -q '.publishedAt' 2>/dev/null || echo "")
              DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/${FILENAME}"
              RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${TAG}"
            fi

            # Copy base config to content directory
            cp "$config" "$CONTENT_DIR/${NAME}.yaml"

            # Append runtime data
            echo "" >> "$CONTENT_DIR/${NAME}.yaml"
            echo "# Runtime data (injected by CI)" >> "$CONTENT_DIR/${NAME}.yaml"

            if [[ -n "$DOWNLOAD_URL" ]]; then
              echo "download_url: \"${DOWNLOAD_URL}\"" >> "$CONTENT_DIR/${NAME}.yaml"
              echo "release_url: \"${RELEASE_URL}\"" >> "$CONTENT_DIR/${NAME}.yaml"
            fi

            if [[ -n "$SHA512" ]]; then
              echo "sha512: \"${SHA512}\"" >> "$CONTENT_DIR/${NAME}.yaml"
            fi

            if [[ -n "$RELEASE_DATE" ]]; then
              echo "release_date: \"${RELEASE_DATE}\"" >> "$CONTENT_DIR/${NAME}.yaml"
            fi

            # Append changelog content
            if [[ -f "$changelog" ]]; then
              echo "changelog: |" >> "$CONTENT_DIR/${NAME}.yaml"
              head -150 "$changelog" | sed 's/^/  /' >> "$CONTENT_DIR/${NAME}.yaml"
            fi

            echo "  -> $CONTENT_DIR/${NAME}.yaml"
          done

          echo "Template content collection generated!"

      - name: Install dependencies
        working-directory: page
        run: npm install

      - name: Build Astro site
        working-directory: page
        run: npm run build

      - name: Generate backward-compatible files
        run: |
          # Generate templates.json for any external consumers
          echo "[]" > page/dist/templates.json

          if [[ -d "page/src/content/templates" ]] && [[ -n "$(ls -A page/src/content/templates 2>/dev/null)" ]]; then
            echo "[" > page/dist/templates.json
            first=true

            for yaml_file in page/src/content/templates/*.yaml; do
              [[ -f "$yaml_file" ]] || continue

              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> page/dist/templates.json
              fi

              # Convert YAML to JSON (excluding changelog for size)
              yq -o=json 'del(.changelog)' "$yaml_file" >> page/dist/templates.json
            done

            echo "]" >> page/dist/templates.json
          fi

          # Generate meta.json
          echo "{\"last_updated\": \"$(date -Iseconds)\", \"generator\": \"astro\"}" > page/dist/meta.json

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./page/dist
          keep_files: false
