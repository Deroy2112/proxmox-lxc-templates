name: Build Debian 13 LXC Template

on:
  push:
    paths:
      - 'templates/**/debian-13/**'
    branches:
      - main
  workflow_dispatch:
    inputs:
      template:
        description: 'Template to build (or "all")'
        required: true
        default: 'all'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      templates: ${{ steps.detect.outputs.templates }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed templates
        id: detect
        run: |
          if [[ "${{ github.event.inputs.template }}" == "all" ]]; then
            templates=$(find templates -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(. != ""))')
          elif [[ -n "${{ github.event.inputs.template }}" ]]; then
            templates='["${{ github.event.inputs.template }}"]'
          else
            changed=$(git diff --name-only HEAD~1 HEAD | grep '^templates/' | cut -d'/' -f2 | sort -u | grep -v '^$' || true)
            if [[ -z "$changed" ]]; then
              templates='[]'
            else
              templates=$(echo "$changed" | jq -R -s -c 'split("\n") | map(select(. != ""))')
            fi
          fi
          echo "templates=${templates}" >> "$GITHUB_OUTPUT"
          echo "Building templates: ${templates}"

  build:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: ${{ needs.detect-changes.outputs.templates != '[]' }}
    strategy:
      matrix:
        template: ${{ fromJson(needs.detect-changes.outputs.templates) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap \
            zstd \
            qemu-user-static

      - name: Install yq
        uses: mikefarah/yq@v4

      - name: Read template config
        id: config
        run: |
          CONFIG="templates/${{ matrix.template }}/debian-13/config.yml"

          NAME=$(yq -r '.name' "$CONFIG")
          VERSION=$(yq -r '.version' "$CONFIG")
          BUILD_VERSION=$(yq -r '.build_version' "$CONFIG")
          BASE_OS=$(yq -r '.base_os' "$CONFIG")
          ARCH=$(yq -r '.architecture // "amd64"' "$CONFIG")

          # User/Group IDs for shared volumes
          USER_UID=$(yq -r '.user.uid // ""' "$CONFIG")
          USER_GID=$(yq -r '.user.gid // ""' "$CONFIG")

          FULL_VERSION="${VERSION}-${BUILD_VERSION}"
          TEMPLATE_FILE="deroy2112-${BASE_OS}-${NAME}_${FULL_VERSION}_${ARCH}.tar.zst"

          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "build_version=$BUILD_VERSION" >> "$GITHUB_OUTPUT"
          echo "full_version=$FULL_VERSION" >> "$GITHUB_OUTPUT"
          echo "base_os=$BASE_OS" >> "$GITHUB_OUTPUT"
          echo "arch=$ARCH" >> "$GITHUB_OUTPUT"
          echo "template_file=$TEMPLATE_FILE" >> "$GITHUB_OUTPUT"
          echo "user_uid=$USER_UID" >> "$GITHUB_OUTPUT"
          echo "user_gid=$USER_GID" >> "$GITHUB_OUTPUT"

      # Cache: Full base system (debootstrap + configured)
      - name: Cache base system
        id: cache-base
        uses: actions/cache@v4
        with:
          path: base-system-cache.tar.zst
          key: base-system-trixie-amd64-v3
          restore-keys: |
            base-system-trixie-amd64-

      - name: Create or restore base system
        run: |
          ROOTFS="${{ runner.temp }}/rootfs"
          CACHE_FILE="${{ github.workspace }}/base-system-cache.tar.zst"

          if [[ -f "$CACHE_FILE" ]]; then
            echo "::notice::Restoring fully configured base system from cache..."
            sudo mkdir -p "$ROOTFS"
            sudo tar --zstd -xf "$CACHE_FILE" -C "$ROOTFS"
          else
            echo "::notice::Building fresh base system (will be cached for future builds)..."
            sudo mkdir -p "$ROOTFS"

            # Debian 13 Trixie debootstrap
            sudo debootstrap \
              --arch=${{ steps.config.outputs.arch }} \
              --include=systemd,systemd-sysv,dbus,apt-utils,locales,iproute2,wget,curl,ca-certificates,less,logrotate,openssh-server \
              trixie \
              "$ROOTFS" \
              http://deb.debian.org/debian

            # Configure base system (only on fresh build)
            sudo chroot "$ROOTFS" /bin/bash <<'BASESCRIPT'
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive

          # Locale
          echo "en_US.UTF-8 UTF-8" > /etc/locale.gen
          locale-gen

          # Timezone
          ln -sf /usr/share/zoneinfo/UTC /etc/localtime

          # Install ALL standard system packages (like official Proxmox templates)
          apt-get update
          apt-get install -y tasksel
          tasksel install standard

          # Proxmox compatibility: disable networkd wait (prevents boot delays)
          mkdir -p /etc/systemd/system-preset
          echo "disable systemd-networkd-wait-online.service" > /etc/systemd/system-preset/00-pve-template.preset

          # Proxmox compatibility: install network tools
          apt-get install -y ifupdown2 isc-dhcp-client

          # Network interfaces - minimal config, Proxmox adds eth0 on container creation
          {
            echo "auto lo"
            echo "iface lo inet loopback"
          } > /etc/network/interfaces

          # Hostname placeholder (Proxmox sets this on container creation)
          echo "localhost" > /etc/hostname

          # Hosts file
          {
            echo "127.0.0.1   localhost"
            echo "::1         localhost ip6-localhost ip6-loopback"
            echo "ff02::1     ip6-allnodes"
            echo "ff02::2     ip6-allrouters"
          } > /etc/hosts

          # Minimal fstab (Proxmox manages mounts)
          echo "# Empty fstab - Proxmox manages container mounts" > /etc/fstab

          # Enable networking service (create symlink directly for chroot compatibility)
          mkdir -p /etc/systemd/system/multi-user.target.wants
          ln -sf /lib/systemd/system/networking.service /etc/systemd/system/multi-user.target.wants/networking.service

          # Clean APT cache before caching base system
          apt-get clean
          rm -rf /var/lib/apt/lists/*
          BASESCRIPT

            # Cache the fully configured base system
            echo "::notice::Saving configured base system to cache..."
            sudo tar --zstd -cf "$CACHE_FILE" -C "$ROOTFS" .
            sudo chown "$(id -u):$(id -g)" "$CACHE_FILE"
          fi

          echo "ROOTFS=$ROOTFS" >> "$GITHUB_ENV"

      # APT Package Cache for template-specific packages
      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: /tmp/apt-cache
          key: apt-${{ matrix.template }}-${{ hashFiles(format('templates/{0}/debian-13/config.yml', matrix.template)) }}
          restore-keys: |
            apt-${{ matrix.template }}-

      - name: Restore APT cache to rootfs
        run: |
          APT_CACHE="/tmp/apt-cache"
          if [[ -d "$APT_CACHE" ]] && [[ -n "$(ls -A "$APT_CACHE" 2>/dev/null)" ]]; then
            echo "::notice::Restoring APT cache..."
            sudo mkdir -p "$ROOTFS/var/cache/apt/archives"
            sudo cp -a "$APT_CACHE"/*.deb "$ROOTFS/var/cache/apt/archives/" 2>/dev/null || true
          fi

      - name: Run template build script
        run: |
          # Copy host DNS for package installation
          sudo cp /etc/resolv.conf "$ROOTFS/etc/resolv.conf"

          # Mount /proc for packages that need it (e.g., OpenJDK)
          # Only mount if not already mounted
          if ! mountpoint -q "$ROOTFS/proc"; then
            sudo mount -t proc proc "$ROOTFS/proc"
            PROC_MOUNTED=1
          fi

          # Ensure /proc is unmounted on exit (even on error)
          cleanup() {
            if [[ "${PROC_MOUNTED:-}" == "1" ]] && mountpoint -q "$ROOTFS/proc"; then
              sudo umount "$ROOTFS/proc" || true
            fi
          }
          trap cleanup EXIT

          sudo cp "templates/${{ matrix.template }}/debian-13/build.sh" "$ROOTFS/tmp/build.sh"
          sudo chmod +x "$ROOTFS/tmp/build.sh"

          if [[ -d "templates/${{ matrix.template }}/debian-13/files" ]]; then
            sudo cp -r "templates/${{ matrix.template }}/debian-13/files" "$ROOTFS/tmp/files"
          fi

          TEMPLATE_VERSION="${{ steps.config.outputs.full_version }}"
          TEMPLATE_NAME="${{ steps.config.outputs.name }}"
          TEMPLATE_REPO="https://github.com/${{ github.repository }}"
          TEMPLATE_UID="${{ steps.config.outputs.user_uid }}"
          TEMPLATE_GID="${{ steps.config.outputs.user_gid }}"

          sudo -E chroot "$ROOTFS" /bin/bash -c "
            set -euo pipefail
            export DEBIAN_FRONTEND=noninteractive
            export TEMPLATE_VERSION='${TEMPLATE_VERSION}'
            export TEMPLATE_NAME='${TEMPLATE_NAME}'
            export TEMPLATE_REPO='${TEMPLATE_REPO}'
            export TEMPLATE_UID='${TEMPLATE_UID}'
            export TEMPLATE_GID='${TEMPLATE_GID}'
            cd /tmp
            ./build.sh
          "

      - name: Save APT cache
        run: |
          APT_CACHE="/tmp/apt-cache"
          echo "::notice::Saving APT cache for future builds..."
          sudo mkdir -p "$APT_CACHE"
          sudo cp -a "$ROOTFS/var/cache/apt/archives"/*.deb "$APT_CACHE/" 2>/dev/null || true
          # Berechtigungen fÃ¼r Cache-Action setzen
          sudo chown -R "$(id -u):$(id -g)" "$APT_CACHE"

      - name: Finalize rootfs
        run: |
          build_date=$(date -Iseconds)
          sudo sed -i "s/__VERSION__/${{ steps.config.outputs.full_version }}/" "$ROOTFS/etc/template-info" 2>/dev/null || true
          sudo sed -i "s/__DATE__/${build_date}/" "$ROOTFS/etc/template-info" 2>/dev/null || true

          sudo chroot "$ROOTFS" /bin/bash <<'CLEANUP'
          set -euo pipefail

          truncate -s 0 /etc/machine-id

          rm -f /etc/ssh/ssh_host_*

          find /var/log -type f -exec truncate -s 0 {} \;

          apt-get clean
          rm -rf /var/lib/apt/lists/*

          rm -rf /tmp/* /var/tmp/*

          rm -f /root/.bash_history

          # Clear resolv.conf (Proxmox will configure DNS)
          truncate -s 0 /etc/resolv.conf
          CLEANUP

      - name: Create tar.zst archive
        run: |
          cd "$ROOTFS"

          sudo tar --numeric-owner --acls --xattrs \
            -cf - . | zstd -T0 -9 -o "${{ runner.temp }}/${{ steps.config.outputs.template_file }}"

          cd "${{ runner.temp }}"
          sha512sum "${{ steps.config.outputs.template_file }}" > "${{ steps.config.outputs.template_file }}.sha512"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: template-${{ matrix.template }}
          path: |
            ${{ runner.temp }}/${{ steps.config.outputs.template_file }}
            ${{ runner.temp }}/${{ steps.config.outputs.template_file }}.sha512

  release:
    needs: [detect-changes, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && needs.detect-changes.outputs.templates != '[]'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for dir in artifacts/template-*/; do
            template=$(basename "$dir" | sed 's/template-//')

            CONFIG="templates/$template/debian-13/config.yml"
            VERSION=$(grep '^version:' "$CONFIG" | cut -d: -f2 | xargs)
            BUILD_VERSION=$(grep '^build_version:' "$CONFIG" | cut -d: -f2 | xargs)
            FULL_VERSION="${VERSION}-${BUILD_VERSION}"
            TAG="v${FULL_VERSION}-${template}"

            # Extract release notes from CHANGELOG.md
            CHANGELOG="templates/$template/debian-13/CHANGELOG.md"
            if [[ -f "$CHANGELOG" ]]; then
              # Extract section for current version (between ## [VERSION] and next ## [)
              RELEASE_NOTES=$(awk -v ver="$FULL_VERSION" '
                /^## \[/ {
                  if (found) exit
                  if (index($0, "## [" ver "]")) found=1
                  next
                }
                found { print }
              ' "$CHANGELOG")

              # Fallback if no matching version found
              if [[ -z "$RELEASE_NOTES" ]]; then
                RELEASE_NOTES="Build of $template version $FULL_VERSION"
              fi
            else
              RELEASE_NOTES="Build of $template version $FULL_VERSION"
            fi

            gh release create "$TAG" \
              --title "$template $FULL_VERSION" \
              --notes "$RELEASE_NOTES" \
              "$dir"/*.tar.zst "$dir"/*.sha512 \
              --latest=false \
              2>/dev/null || \
            gh release upload "$TAG" \
              "$dir"/*.tar.zst "$dir"/*.sha512 \
              --clobber
          done
